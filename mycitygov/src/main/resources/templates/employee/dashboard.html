<!DOCTYPE html>
<html lang="el"
      xmlns:th="http://www.thymeleaf.org"
      xmlns:layout="http://www.ultraq.net.nz/thymeleaf/layout"
      layout:decorate="~{base}">
<head>
    <title>Employee Workspace</title>
</head>
<body>
<section layout:fragment="main">
    <div class="container-fluid py-4">

        <div class="d-flex justify-content-between align-items-center mb-4">
            <span th:if="${employee.department != null}" th:text="${employee.department.name}">Dept</span>
            <span th:if="${employee.department == null}" class="text-danger">NO DEPARTMENT</span>
            <span class="text-muted" th:text="${#temporals.format(#temporals.createNow(), 'dd MMMM yyyy')}">Date</span>
        </div>

        <div th:if="${successMessage}" class="alert alert-success" th:text="${successMessage}"></div>
        <div th:if="${errorMessage}" class="alert alert-danger" th:text="${errorMessage}"></div>

        <div class="row">

            <div class="col-lg-8">

                <div class="card shadow-sm mb-4 border-warning">
                    <div class="card-header bg-warning text-dark fw-bold">
                        Incoming Requests
                    </div>
                    <div class="card-body p-0">
                        <table class="table table-hover mb-0">
                            <thead>
                            <tr>
                                <th>Date</th>
                                <th>Type</th>
                                <th>Citizen</th>
                                <th>Action</th>
                            </tr>
                            </thead>
                            <tbody>
                            <tr th:each="req : ${unassignedRequests}">
                                <td th:text="${#temporals.format(req.submissionDate, 'dd/MM/yy')}"></td>
                                <td th:text="${req.requestType?.name}">Type</td>
                                <td th:text="${req.citizen?.firstName} + ' ' + ${req.citizen?.lastName}">Name</td>
                                <td>
                                    <form th:action="@{'/employee/requests/' + ${req.id} + '/claim'}" method="post">
                                        <button type="submit" class="btn btn-sm btn-outline-dark">
                                            Take
                                        </button>
                                    </form>
                                </td>
                            </tr>
                            <tr th:if="${#lists.isEmpty(unassignedRequests)}">
                                <td colspan="4" class="text-center text-muted">No new requests.</td>
                            </tr>
                            </tbody>
                        </table>
                    </div>
                </div>

                <div class="card shadow-sm mb-4 border-primary">
                    <div class="card-header bg-primary text-white fw-bold">
                        My Active Tasks
                    </div>
                    <div class="card-body">
                        <div th:each="req : ${myRequests}" class="border-bottom pb-3 mb-3">

                            <div class="d-flex justify-content-between align-items-start">
                                <div>
                                    <h5 class="fw-bold mb-0" th:text="${req.requestType?.name}">Type</h5>
                                    <small class="text-muted">
                                        Citizen: <span th:text="${req.citizen?.firstName} + ' ' + ${req.citizen?.lastName}">Name</span>
                                    </small>
                                </div>
                                <span th:class="'badge ' +
              (${req.status?.name() == 'SUBMITTED'} ? 'bg-primary' :
              (${req.status?.name() == 'IN_PROGRESS'} ? 'bg-info' : 'bg-secondary'))"
                                      th:text="${req.status}">STATUS</span>
                            </div>

                            <div class="mt-2 p-2 bg-light rounded border">
                                <strong>Description:</strong>
                                <p class="mb-0 fst-italic" th:text="${req.description}">Original Description</p>
                            </div>

                            <div th:if="${not #lists.isEmpty(req.attachments)}" class="mt-2">
                                <strong>Attachments:</strong>
                                <ul class="list-unstyled">
                                    <li th:each="att : ${req.attachments}">
                                        <a th:href="@{'/employee/requests/' + ${req.id} + '/attachments/' + ${att.id} + '/download'}"
                                           class="btn btn-outline-primary btn-sm mb-1" target="_blank">
                                            <span th:text="${att.fileName}">File.pdf</span>
                                        </a>
                                    </li>
                                </ul>
                            </div>

                            <div th:if="${req.comments != null and !#strings.isEmpty(req.comments)}" class="mt-2">
                                <label class="small fw-bold text-muted">History/Chat:</label>
                                <div class="alert alert-secondary py-1 px-2 small"
                                     style="white-space: pre-wrap;"
                                     th:text="${req.comments}">
                                    History logs...
                                </div>
                            </div>

                            <form th:if="${req.status?.name() == 'IN_PROGRESS' or req.status?.name() == 'SUBMITTED' or req.status?.name() == 'PENDING_INFO'}"
                                  th:action="@{'/employee/requests/' + ${req.id} + '/process'}"
                                  method="post"
                                  enctype="multipart/form-data"
                                  class="mt-3 border-top pt-2">

                                <label class="form-label small fw-bold">Your Reply/Action:</label>
                                <textarea name="comments" class="form-control form-control-sm mb-2" rows="2"
                                          placeholder="Write instructions or rejection reason here..."></textarea>

                                <div class="mb-2">
                                    <input type="file" name="resultFile" class="form-control form-control-sm">
                                    <div class="form-text" style="font-size: 0.75rem;">Upload result document (Required for Approval)</div>
                                </div>

                                <div class="d-flex gap-2">
                                    <button type="submit" name="action" value="approve" class="btn btn-success btn-sm">
                                        O Approve
                                    </button>
                                    <button type="submit" name="action" value="info" class="btn btn-warning btn-sm text-dark">
                                        ? Ask More Info
                                    </button>
                                    <button type="submit" name="action" value="reject" class="btn btn-danger btn-sm">
                                        X Reject
                                    </button>
                                </div>
                            </form>

                            <div th:if="${req.status?.name() == 'APPROVED' or req.status?.name() == 'REJECTED'}" class="alert alert-light mt-2">
                                <strong>Final Status:</strong> <span th:text="${req.status}"></span>
                            </div>
                        </div>

                        <div th:if="${#lists.isEmpty(myRequests)}" class="text-center text-muted">
                            You have no active tasks.
                        </div>
                    </div>
                </div>

            </div>

            <div class="col-lg-4">
                <div class="card shadow h-100">
                    <div class="card-header bg-success text-white fw-bold">
                        Appointments
                    </div>
                    <ul class="list-group list-group-flush">
                    <li class="list-group-item" th:each="app : ${appointments}">
                        <div class="d-flex justify-content-between align-items-center">
                            <span th:text="${app.slot?.date}">2026-01-16</span>
                            <span class="badge bg-light text-dark border"
                                  th:text="${app.slot?.startTime}">09:00</span>

                            <span th:class="'badge ' +
                  (${app.status?.name() == 'CANCELLED'} ? 'bg-danger' :
                  (${app.status?.name() == 'COMPLETED'} ? 'bg-success' : 'bg-primary'))"
                                  th:text="${app.status}">BOOKED</span>
                        </div>

                        <div class="mt-2 fw-bold"
                             th:text="${app.citizen?.firstName} + ' ' + ${app.citizen?.lastName}">Name</div>

                        <small class="text-muted d-block mb-2">Ref: <span th:text="${app.referenceCode}"></span></small>

                        <div th:if="${app.status?.name() == 'BOOKED'}" class="d-flex gap-2">
                            <form th:action="@{'/employee/appointments/' + ${app.id} + '/complete'}" method="post">
                                <button type="submit" class="btn btn-success btn-sm py-0" style="font-size: 0.8rem;">
                                    Finish
                                </button>
                            </form>

                            <form th:action="@{'/employee/appointments/' + ${app.id} + '/cancel'}" method="post">
                                <button type="submit" class="btn btn-outline-danger btn-sm py-0" style="font-size: 0.8rem;">
                                    Cancel
                                </button>
                            </form>
                        </div>
                    </li>

                    <li class="list-group-item text-center text-muted" th:if="${#lists.isEmpty(appointments)}">
                        No appointments today.
                    </li>
                    </ul>
                </div>
            </div>
        </div>
    </div>
</section>
</body>
</html>